botu_count<-botucount[(botucount$Phylum!="Unclassified"),]
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
dataset<-cbind(oatmelt,xoatmelt[2])
otucount<-dataset%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarize(Numb_otu=n())
dim(otucount)
relabunds<-dataset%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(abundance=sum(relative_abundance))
dim(relabunds)
bubbledata<-cbind(otucount,relabunds[3])
head(bubbledata)
#SHowing between phylums
bubbledata[bubbledata==0]<-NA
unique(bubbledata$Phylum)
ggplot(dataset, aes(variable, y=value,fill=Phylum)) + geom_bar(position="fill",stat="identity")+
scale_fill_manual(values = c(Annelida,Arthropoda,Bacillariophyta,Brachiopoda,Bryoza,Chlorophyta,Chordata,
Ciliophora, Cnidaria,Dinoflagellata,Echinodermata,Euglenoza,Kinorhyncha,
Magnoliophyta,Mollusca,Nematoda,Platyhelminthes,Porifera,
Rhodophyta,Unclassified))+
labs(x="Species",y="Relative abundance")+ theme(legend.title=element_blank())+
scale_x_discrete(labels = expression(italic(T.aurantium),italic(T.meloni),italic(T.citroni)))+
theme_bw() + theme(axis.text.x=element_text(angle=0,hjust=0.5,size=9))+
ggsave("relative_abundances_18s.png",path=plotsPath,dpi=300,units="cm",width=30,height=20)
#
ggplot(bdataset, aes(variable, y=relative_abundance)) + geom_col(aes(fill=Phylum),position="fill") +
scale_fill_manual(values = c(Annelida,Arthropoda,Bacillariophyta,Brachiopoda,Bryoza,Chlorophyta,Chordata,
Ciliophora, Cnidaria,Dinoflagellata,Echinodermata,Euglenoza,Kinorhyncha,
Magnoliophyta,Mollusca,Nematoda,Platyhelminthes,Porifera,
Rhodophyta))+
labs(x="Species",y="Relative abundance")+scale_x_discrete(labels = expression(italic(T.aurantium),italic(T.meloni),italic(T.citroni)))+theme_bw() + theme(axis.text.x=element_text(angle=0,hjust=0.5,size=9))
View(botucount)
ggplot(bubbledata,aes(x=Phylum,y=Numb_otu,colour=variable,size=abundance))+geom_point()
#Showing between species
ggplot(bubbledata,aes(x=variable,y=Numb_otu,color=Phylum,size=abundance))+
scale_color_manual(values=c(Annelida,Arthropoda,Bacillariophyta,Brachiopoda,Bryoza,Chlorophyta,
Chordata,Ciliophora, Cnidaria,Dinoflagellata,Echinodermata,Euglenoza,
Kinorhyncha,Magnoliophyta,Mollusca,Nematoda,Platyhelminthes,Porifera,
Rhodophyta,Unclassified))+labs(x="Species",y="Phylum Richness",size="Relative abundance")+
scale_size(range = c(.9,15))+theme_bw()+geom_jitter(width=0.3,alpha=0.9)+scale_x_discrete(labels=c("Tethya aurantium","Tethia citrina","Tethya meloni"))+
theme(axis.text.x = element_text(face = "italic"),legend.margin = margin(0,0,0,-2))+
guides(color = guide_legend(override.aes = list(size = 5),ncol=2 ),size=guide_legend(nrow=1) )
otucount2<-oatmelt%>%
filter(val>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(Numb_otu=n())
head(oatmelt)
otucount2<-oatmelt%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(Numb_otu=n())
otucount2<-oatmelt%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(Numb_otu=n())
relabunds<-dataset%>%
group_by(Phylum,variable)%>%
summarise(abundance=sum(relative_abundance))
bubbledata<-cbind(otucount2,relabunds[3])
dim(otucount2)
dim(relabunds)
relabunds<-dataset%>%
filter(value>0)
relabunds<-dataset%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
summarise(abundance=sum(relative_abundance))
bubbledata<-cbind(otucount2,relabunds[3])
#SHowing between phylums
bubbledata[bubbledata==0]<-NA
ggplot(bubbledata,aes(x=Phylum,y=Numb_otu,colour=variable,size=abundance))+geom_point()
#Showing between species
ggplot(bubbledata,aes(x=variable,y=Numb_otu,color=Phylum,size=abundance))+
scale_color_manual(values=c(Annelida,Arthropoda,Bacillariophyta,Brachiopoda,Bryoza,Chlorophyta,
Chordata,Ciliophora, Cnidaria,Dinoflagellata,Echinodermata,Euglenoza,
Kinorhyncha,Magnoliophyta,Mollusca,Nematoda,Platyhelminthes,Porifera,
Rhodophyta,Unclassified))+labs(x="Species",y="Phylum Richness",size="Relative abundance")+
scale_size(range = c(.9,15))+theme_bw()+geom_jitter(width=0.3,alpha=0.9)+scale_x_discrete(labels=c("Tethya aurantium","Tethia citrina","Tethya meloni"))+
theme(axis.text.x = element_text(face = "italic"),legend.margin = margin(0,0,0,-2))+
guides(color = guide_legend(override.aes = list(size = 5),ncol=2 ),size=guide_legend(nrow=1) )
head(bubbledata)
View(bubbledata)
View(oatmelt)
View(dataset)
#Melt table to make phylum ID
#remove all columns except OTU ID, samples and phyla
oatmelt<-melt(oat[-c(46:50,52:56)])
head(oat)
dim(oat)
#Melt table to make phylum ID
#remove all columns except OTU ID, samples and phyla
oatmelt<-melt(oat[-c(1,46:50,52:56)])
uncorrectedCountsPath<-"./Data/16s_allsamples_otu.csv"
#tbc bactLoadCorrectedCountsPath<-"./Data/all.otutab_Corrected_valuesOnly.csv"
otuTaxonomyPath<-"./Data/16s_allsamples_taxa.csv"
otuTaxonomy<-read.csv(otuTaxonomyPath, sep=";")
countsDF<-read.csv(uncorrectedCountsPath, sep=";")
head(otuTaxonomy)
data<-cbind(countsDF,otuTaxonomy)
#If  you want to filter up to 95% abuncance
#Alculate pct abundance to filter out the last 5%
countSum<-apply(countsDF[2:45],1,sum) #sum the rows
pct<-countSum/sum(countSum)
xdata<-cbind(data,countSum, pct)
xdata<-xdata%>%
arrange(desc(pct))
xdata<-xdata%>%
mutate(cumpct=cumsum(pct))
#There are more otus with more or equal to 50 reads over the
#95% cumpct abundance threshold so use at least 50 reads as
#filter point instead
dim(xdata)
xdata<-xdata[xdata$countSum >=50,]
dim(xdata)
#Delete the cumpct and pct rows again
head(xdata)
xdata=select(xdata,-countSum,-pct,-cumpct)
#Make into presence absence data
OTUPresence<-as.data.frame(xdata[,2:45]>0)#turns into logical value, true or false if present or not
#FIll blank boxes with "unclassified"
head(xdata)
xdata[xdata==""]<-"Unclasssified"
unique(xdata$Phylum)
#Melt data set and remove unnecassary rows
datamelt<-melt(xdata[-c(1,46,47,49:53)])
dim(datamelt)
head(datamelt)#Set levels
#Make each variable (sample names) a level
levels(oatmelt$variable)<-c("GW1941","GW1942" ,"GW1943","GW1944", "GW1945", "GW1946", "GW1947", "GW1948","GW1949","GW1950","GW1951",
"GW1952", "GW1953", "GW1954", "GW1955","GW1956", "GW1957", "GW1958", "GW1959","GW1960","GW1961","GW1962",
"GW1963","GW1964","GW1965","GW1966", "GW1967", "GW1968", "GW1969", "GW1970", "GW1971","GW1972","GW1973","GW1974", "GW1975","GW1976", "GW1977", "GW1978","GW1979", "GW1980", "GW1981", "GW1982", "GW1983", "GW1984")
#Assign species names to each sample via the levels
levels(oatmelt$variable)<-c("Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau",
"Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tme","Tme","Tau")
##########
zoatmelt<-oatmelt%>%
group_by(variable)%>%
summarise(relative_abundance=value/sum(value))
#Check relative abundances add up to 1 for each sp
sum(zoatmelt$relative_abundance[zoatmelt$variable=="Tci"])
head(zoatmelt)
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
dataset<-cbind(oatmelt,zoatmelt[2])
####Core dataset
#DAta with just the core OTUs and also with just non core OTUs
##core
head(core_community)
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
dataset<-cbind(oatmelt,zoatmelt[2])
unique(oat$Phylum)
####Core dataset
#DAta with just the core OTUs and also with just non core OTUs
##core
head(core_community)
coredata<-oat[oat$X.OTU.ID %in% core_community$X.OTU.ID,]
dim(coredata)
coredatamelt<-melt(coredata[-c(1,46:50,52:56)])
levels(coredatamelt$variable)<-c("GW1941","GW1942" ,"GW1943","GW1944", "GW1945", "GW1946", "GW1947", "GW1948","GW1949","GW1950","GW1951",
"GW1952","GW1953", "GW1954", "GW1955", "GW1956", "GW1957", "GW1958", "GW1959","GW1960","GW1961","GW1962",
"GW1963","GW1964","GW1965", "GW1966", "GW1967", "GW1968", "GW1969","GW1970","GW1971","GW1972", "GW1973","GW1974", "GW1975", "GW1976", "GW1977", "GW1978", "GW1979","GW1980","GW1981", "GW1982","GW1983", "GW1984")
levels(coredatamelt$variable)<-c("Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau",
"Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tme","Tme","Tau")
##for core dataset
#Group by species and calc relative abundance of each OTU for each species
xcoredatamelt<-coredatamelt%>%
group_by(variable)%>%
summarise(relative_abundance=value/sum(value))
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
coredataset<-cbind(coredatamelt,xcoredatamelt[2])
###########
##Set colours
Unclassified<-"slategray"
Ciliophora<-"green4"
Platyhelminthes<-"wheat3"
Rhodophyta<-"navyblue"
Porifera<-"yellow2"
Annelida<-"violetred4"
Nematoda<-"violetred2"
Cnidaria<-"violetred"
Euglenoza<-"violet"
Bacillariophyta<-"turquoise2"
Magnoliophyta<-"darkgreen"
Mollusca<-"tomato3"
Bryoza<-"tomato1"
Echinodermata<-"purple"
Kinorhyncha<-"springgreen2"
Chlorophyta<-"tan4"
Arthropoda<-"tan3"
Dinoflagellata<-"steelblue4"
Brachiopoda<-"steelblue2"
Chordata<-"yellowgreen"
####
head(dataset)
ggplot(dataset, aes(variable, y=value,fill=Phylum)) + geom_bar(position="fill",stat="identity")+
scale_fill_manual(values = c(Annelida,Arthropoda,Bacillariophyta,Brachiopoda,Bryoza,Chlorophyta,Chordata,
Ciliophora, Cnidaria,Dinoflagellata,Echinodermata,Euglenoza,Kinorhyncha,
Magnoliophyta,Mollusca,Nematoda,Platyhelminthes,Porifera,
Rhodophyta,Unclassified))+
labs(x="Species",y="Relative abundance")+ theme(legend.title=element_blank())+
scale_x_discrete(labels = expression(italic(T.aurantium),italic(T.meloni),italic(T.citroni)))+
theme_bw() + theme(axis.text.x=element_text(angle=0,hjust=0.5,size=9))+
ggsave("relative_abundances_18s.png",path=plotsPath,dpi=300,units="cm",width=30,height=20)
botucount<-dataset%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarize(Numb_otu=n())
relabunds<-dataset%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(abundance=sum(relative_abundance))
bubbledata<-cbind(otucount,relabunds[3])
bubbledata<-cbind(botucount,relabunds[3])
#SHowing between phylums
bubbledata[bubbledata==0]<-NA
ggplot(bubbledata,aes(x=Phylum,y=Numb_otu,colour=variable,size=abundance))+geom_point()
#Showing between species
ggplot(bubbledata,aes(x=variable,y=Numb_otu,color=Phylum,size=abundance))+
scale_color_manual(values=c(Annelida,Arthropoda,Bacillariophyta,Brachiopoda,Bryoza,Chlorophyta,
Chordata,Ciliophora, Cnidaria,Dinoflagellata,Echinodermata,Euglenoza,
Kinorhyncha,Magnoliophyta,Mollusca,Nematoda,Platyhelminthes,Porifera,
Rhodophyta,Unclassified))+labs(x="Species",y="Phylum Richness",size="Relative abundance")+
scale_size(range = c(.9,15))+theme_bw()+geom_jitter(width=0.3,alpha=0.9)+scale_x_discrete(labels=c("Tethya aurantium","Tethia citrina","Tethya meloni"))+
theme(axis.text.x = element_text(face = "italic"),legend.margin = margin(0,0,0,-2))+
guides(color = guide_legend(override.aes = list(size = 5),ncol=2 ),size=guide_legend(nrow=1) )
otucount2<-oatmelt%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(Numb_otu=count())
otucount2<-oatmelt%>%
filter(value>0)%>%
group_by(Phylum,variable)%>%
dplyr::summarise(Numb_otu=tally())
otucount<-dataset%>%
filter(value>0)
otucount<-otucount%>%
group_by(Phylum,variable)%>%
dplyr::summarize(Numb_otu=n())
dim(otucount)
relabunds<-dataset%>%
filter(value>0)
relabunds<-relabunds%>%
group_by(Phylum,variable)%>%
dplyr::summarise(abundance=sum(relative_abundance))
bubbledata<-cbind(otucount,relabunds[3])
head(bubbledata)
#SHowing between phylums
bubbledata[bubbledata==0]<-NA
ggplot(bubbledata,aes(x=variable,y=Numb_otu,color=Phylum,size=abundance))+
scale_color_manual(values=c(AcidobacteriotaCol,ActinobacteriotaCol,BacteroidotaCol,
CalditrichotaCol,ChloroflexiCol,CrenarchaeotaCol,CyanobacteriaCol,
DadabacteriaCol,DeferrisomatotaCol,DeinococcotaCol,DesulfobacterotaCol,
EntotheonellaeotaCol,GemmatimonadotaCol,
LatescibacterotaCol,MyxococcotaCol,NB1jCol,NitrospinotaCol,NitrospirotaCol,
PlanctomycetotaCol,ProteobacteriaCol,SAR324cladeCol,SpirochaetotaCol,
UnclassifiedCol,VerrucomicrobiotaCol))+labs(x="Species",y="Phylum Richness",size="Relative abundance")+
scale_size(range = c(.9,15))+theme_bw()+geom_jitter(width=0.3,alpha=0.9)+scale_x_discrete(labels=c("Tethya aurantium","Tethia citrina","Tethya meloni"))+
theme(axis.text.x = element_text(face = "italic"),legend.margin = margin(0,0,0,-2))+
guides(color = guide_legend(override.aes = list(size = 5),ncol=2),size=guide_legend(nrow=1) )
bubbledata<-cbind(otucount,relabunds[3])
head(bubbledata)
#SHowing between phylums
bubbledata[bubbledata==0]<-NA
ggplot(bubbledata,aes(x=variable,y=Numb_otu,color=Phylum,size=abundance))+
scale_color_manual(values=c(AcidobacteriotaCol,ActinobacteriotaCol,BacteroidotaCol,
CalditrichotaCol,ChloroflexiCol,CrenarchaeotaCol,CyanobacteriaCol,
DadabacteriaCol,DeferrisomatotaCol,DeinococcotaCol,DesulfobacterotaCol,
EntotheonellaeotaCol,GemmatimonadotaCol,
LatescibacterotaCol,MyxococcotaCol,NB1jCol,NitrospinotaCol,NitrospirotaCol,
PlanctomycetotaCol,ProteobacteriaCol,SAR324cladeCol,SpirochaetotaCol,
UnclassifiedCol,VerrucomicrobiotaCol))+labs(x="Species",y="Phylum Richness",size="Relative abundance")+
scale_size(range = c(.9,15))+theme_bw()+geom_jitter(width=0.3,alpha=0.9)+scale_x_discrete(labels=c("Tethya aurantium","Tethia citrina","Tethya meloni"))+
theme(axis.text.x = element_text(face = "italic"),legend.margin = margin(0,0,0,-2))+
guides(color = guide_legend(override.aes = list(size = 5),ncol=2),size=guide_legend(nrow=1) )
head(nbubbledata)
#Melt data set and remove unnecassary rows
datamelt<-melt(xdata[-c(46,47,49:53)])
#Group by species and calc relative abundance of each OTU for each species
xdatamelt<-datamelt%>%
group_by(X.OTU.ID,variable)%>%
summarise(relative_abundance=value/sum(value))
dim(xdatamelt)
head(datamelt)
levels(datamelt$variable)<-c("GW1941","GW1942" ,"GW1943","GW1944", "GW1945", "GW1946", "GW1947", "GW1948","GW1949","GW1950","GW1951",
"GW1952","GW1953", "GW1954", "GW1955", "GW1956", "GW1957", "GW1958", "GW1959","GW1960","GW1961","GW1962",
"GW1963","GW1964","GW1965", "GW1966", "GW1967", "GW1968", "GW1969","GW1970","GW1971","GW1972", "GW1973","GW1974", "GW1975", "GW1976", "GW1977", "GW1978", "GW1979","GW1980","GW1981", "GW1982","GW1983", "GW1984")
levels(datamelt$variable)<-c("Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau",
"Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tme","Tme","Tau")
#Group by species and calc relative abundance of each OTU for each species
xdatamelt<-datamelt%>%
group_by(X.OTU.ID,variable)%>%
summarise(relative_abundance=value/sum(value))
dim(xdatamelt)
head(datamelt)
dim(xdatamelt)
head(xdatamelt)
#Group by species and calc relative abundance of each OTU for each species
xdatamelt<-datamelt%>%
group_by(X.OTU.ID)%>%
summarise(relative_abundance=value/sum(value))
dim(xdatamelt)
head(xdatamelt)
head(xdata)
which(colnames=="GW1958")
which(colname=="GW1958")
which(col=="GW1958")
which(names=="GW1958")
trial<-xdata%>%
rowwise() %>%
group_by(X.OTU.ID)
trial<-xdata%>%
rowwise() %>%
group_by(X.OTU.ID)%>%
mutate(
sumtau = sum(c_across(c(2:12,45)))/12,
sumtme = sum(c_across(c(13:23,43,44)))/13,
sumtci = sum(c_across(24:42))/19
)
trial<-xdata%>%
rowwise() %>%
mutate(
sumtau = sum(c_across(c(2:12,45)))/12,
sumtme = sum(c_across(c(13:23,43,44)))/13,
sumtci = sum(c_across(24:42))/19
)
head(trial)
View(trial)
trial<-xdata%>%
rowwise() %>%
mutate(
sumtau = sum(c_across(c(2:12,45))),
sumtme = sum(c_across(c(13:23,43,44))),
sumtci = sum(c_across(24:42))
)
xdata<-xdata[,c(46,48,54:56)]
xdata<-xdata[c(46,48,54:56)]
ydata<-trial[,c(46,48,54:56)]
ydatamelt<-melt(ydata)
head(ydatamelt)
View(ydata)
#Group by species and calc relative abundance of each OTU for each species
###THE ISSUE HERE
xdatamelt<-ydatamelt%>%
group_by(Phylum)%>%
summarise(relative_abundance=value/sum(value))
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
dataset<-cbind(ydatamelt,xdatamelt[2])
#DAta with just the core OTUs and also with just non core OTUs
##core
coredata<-xdata[xdata$X.OTU.ID %in% core_community$X.OTU.ID,]
head(coredata)
coredatamelt<-melt(coredata[-c(1,46,47,49:53)])
levels(coredatamelt$variable)<-c("GW1941","GW1942" ,"GW1943","GW1944", "GW1945", "GW1946", "GW1947", "GW1948","GW1949","GW1950","GW1951",
"GW1952","GW1953", "GW1954", "GW1955", "GW1956", "GW1957", "GW1958", "GW1959","GW1960","GW1961","GW1962",
"GW1963","GW1964","GW1965", "GW1966", "GW1967", "GW1968", "GW1969","GW1970","GW1971","GW1972", "GW1973","GW1974", "GW1975", "GW1976", "GW1977", "GW1978", "GW1979","GW1980","GW1981", "GW1982","GW1983", "GW1984")
levels(coredatamelt$variable)<-c("Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau",
"Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tme","Tme","Tau")
##for core dataset
#Group by species and calc relative abundance of each OTU for each species
xcoredatamelt<-coredatamelt%>%
group_by(variable)%>%
summarise(relative_abundance=value/sum(value))
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
coredataset<-cbind(coredatamelt,xcoredatamelt[2])
##non-core
noncoredata<-xdata[!(xdata$X.OTU.ID %in% core_community$X.OTU.ID),]#HEREEE
noncoredatamelt<-melt(noncoredata[-c(1,46,47,49:53)])
#
levels(noncoredatamelt$variable)<-c("GW1941","GW1942" ,"GW1943","GW1944", "GW1945", "GW1946", "GW1947", "GW1948","GW1949","GW1950","GW1951",
"GW1952","GW1953", "GW1954", "GW1955", "GW1956", "GW1957", "GW1958", "GW1959","GW1960","GW1961","GW1962",
"GW1963","GW1964","GW1965", "GW1966", "GW1967", "GW1968", "GW1969","GW1970","GW1971","GW1972", "GW1973","GW1974", "GW1975", "GW1976", "GW1977", "GW1978", "GW1979","GW1980","GW1981", "GW1982","GW1983", "GW1984")
levels(noncoredatamelt$variable)<-c("Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau",
"Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tme","Tme","Tau")
##REpeat for noncore dataset
#Group by species and calc relative abundance of each OTU for each species
xnoncoredatamelt<-noncoredatamelt%>%
group_by(variable)%>%
summarise(relative_abundance=value/sum(value))
#Bind the "relative_abundance" col (for each sp seperately) to the main data set
noncoredataset<-cbind(noncoredatamelt,xnoncoredatamelt[2])
##########
unique(dataset$Phylum)
################
AcidobacteriotaCol<-"yellowgreen"
ActinobacteriotaCol<-"yellow2"
BacteroidotaCol<-"wheat3"
BdellovibrionotaCol<-"darkslategray"
CalditrichotaCol<-"tomato3"
CampylobacterotaCol<-"wheat1"
ChloroflexiCol<-"violetred2"
CrenarchaeotaCol<-"violetred"
CyanobacteriaCol<-"violet"
DadabacteriaCol<-"turquoise4"
DeferrisomatotaCol<-"turquoise3"
DeinococcotaCol<-"turquoise"
#DependentiaeCol<-"tomato3"
DesulfobacterotaCol<-"tomato1"
EntotheonellaeotaCol<-"Violetred4"
#FirmicutesCol<-"black"
#FusobacteriotaCol<-"rosybrown3"
GemmatimonadotaCol<-"tan3"
#HydrogenedentesCol<-"tan1"
LatescibacterotaCol<-"steelblue4"
MyxococcotaCol<-"steelblue2"
NB1jCol<-"springgreen4"
NitrospinotaCol<-"springgreen2"
NitrospirotaCol<-"slategray2"
PAUC34fCol<-"darkkhaki"
PlanctomycetotaCol<-"purple4"
ProteobacteriaCol<-"salmon"
SAR324cladeCol<-"royalblue"
SpirochaetotaCol<-"tan4"
#SumerlaeotaCol<-"red2"
UnclassifiedCol<-"slategray"
VerrucomicrobiotaCol<-"purple"
WPS2Col<-"plum3"
#WS1Col<-"orange"
######
library
??fct_reorder
unique(dataset$Phylum)
head(dataset)
dataset_n<-dataset
dataset_n$Phylum<-factor(dataset_n$Phylum,levels=c(unique(dataset$Phylum)))
ggplot(dataset_n, aes(variable, y=relative_abundance,fill=Phylum)) + geom_bar(aes(fill=Phylum),stat="identity", position="fill") +
scale_fill_manual(values = c(ProteobacteriaCol,UnclassifiedCol,CrenarchaeotaCol,ActinobacteriotaCol,BacteroidotaCol,CyanobacteriaCol,PlanctomycetotaCol,
VerrucomicrobiotaCol,DesulfobacterotaCol,AcidobacteriotaCol,NitrospirotaCol,SpirochaetotaCol,NitrospinotaCol,
DeferrisomatotaCol,DadabacteriaCol,MyxococcotaCol,SAR324cladeCol,NB1jCol,DeinococcotaCol,ChloroflexiCol,CalditrichotaCol,EntotheonellaeotaCol,LatescibacterotaCol,GemmatimonadotaCol)) +
labs(x="Species",y="Relative abundance")+
scale_x_discrete(labels = expression(italic(T.aurantium),italic(T.meloni),italic(T.citrina)))+
theme_bw() + theme(axis.text.x=element_text(angle=0,hjust=0.5,size=9))
dev.off()
#Core OTUs
unique(coredataset$Phylum)
coredataset_n<-coredataset
coredataset_n$Phylum<-factor(coredataset_n$Phylum,levels=c(unique(coredataset$Phylum)))
png("./Figures/AS_16splots/relativeabundance-corephyla.png",height=10,width=20,units="cm",res=300)
#non core phyla
unique(noncoredataset$Phylum)
noncoredataset_n<-noncoredataset
noncoredataset_n$Phylum<-factor(noncoredataset_n$Phylum,levels=c(unique(noncoredataset$Phylum)))
#TO look at OTUs across sp and sample in the core OTUs
coredataprop<-coredata
coredataprop[,2:45]<-apply(coredata[,2:45],2,function(x) x/sum(x))
mcore_otu<-melt(coredataprop)
levels(mcore_otu$variable)<-c("GW1941","GW1942" ,"GW1943","GW1944", "GW1945", "GW1946", "GW1947", "GW1948","GW1949","GW1950","GW1951",
"GW1952","GW1953", "GW1954", "GW1955", "GW1956", "GW1957", "GW1958", "GW1959","GW1960","GW1961","GW1962",
"GW1963","GW1964","GW1965", "GW1966", "GW1967", "GW1968", "GW1969","GW1970","GW1971","GW1972", "GW1973","GW1974", "GW1975", "GW1976", "GW1977", "GW1978", "GW1979","GW1980","GW1981", "GW1982","GW1983", "GW1984")
levels(mcore_otu$variable)<-c("Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau","Tau",
"Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme","Tme",
"Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tci","Tme","Tme","Tau")
unique(mcore_otu$Phylum)
nmcore_otu<-mcore_otu
nmcore_otu$Phylum<-factor(nmcore_otu$Phylum,levels=c(unique(nmcore_otu$Phylum)))
ggplot(nmcore_otu, aes(x=X.OTU.ID, y=value)) + geom_boxplot(aes(fill=Phylum)) +
geom_jitter(colour="gray80", alpha=0.65) + facet_grid(cols=vars(variable)) +
scale_fill_manual(values = c(CrenarchaeotaCol,UnclassifiedCol, ActinobacteriotaCol, BacteroidotaCol, CyanobacteriaCol,PlanctomycetotaCol, ProteobacteriaCol, DesulfobacterotaCol, NitrospirotaCol,AcidobacteriotaCol,DadabacteriaCol,VerrucomicrobiotaCol)) +
theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1),legend.position="top",legend.direction="horizontal")
dev.off()
#FOr just one sp?
Tau_corePropsWithTaxonomyMelted<-subset(mcore_otu, variable=="Tau")
unique(Tau_corePropsWithTaxonomyMelted$Phylum)
#High abundance cc (above 0.1 relative abundance in any sample)
core_high<-mcore_otu%>%
arrange(desc(value))%>%
filter(value>0.1)
unique(core_high$Phylum)
ncore_high<-core_high
ncore_high$Phylum<-factor(ncore_high$Phylum,levels=c(unique(ncore_high$Phylum)))
ggplot(ncore_high, aes(X.OTU.ID, y=value)) +
geom_boxplot(aes(fill=Phylum)) + geom_jitter(colour="gray80", alpha=0.65) + facet_grid(cols=vars(variable)) + scale_fill_manual(values = c(CrenarchaeotaCol,UnclassifiedCol,PlanctomycetotaCol,CyanobacteriaCol,ActinobacteriotaCol, BacteroidotaCol, ProteobacteriaCol, NitrospirotaCol)) + theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1))
ggplot(ncore_high, aes(variable, y=value)) + geom_boxplot(aes(fill=Phylum))+ geom_jitter(colour="gray80", alpha=0.65) + facet_grid(cols=vars(X.OTU.ID)) + scale_fill_manual(values = c(CrenarchaeotaCol,UnclassifiedCol,PlanctomycetotaCol,CyanobacteriaCol,ActinobacteriotaCol, BacteroidotaCol, ProteobacteriaCol, NitrospirotaCol)) + theme_bw() + theme(axis.text.x=element_text(angle=90,hjust=1))
core_low<-mcore_otu%>%
arrange(desc(value))%>%
filter(value<=0.1)
ncore_low<-core_low
otucount<-dataset%>%
filter(value>0)
otucount<-otucount%>%
group_by(Phylum,variable)%>%
dplyr::summarize(Numb_otu=n())
relabunds<-dataset%>%
filter(value>0)
relabunds<-relabunds%>%
group_by(Phylum,variable)%>%
dplyr::summarise(abundance=sum(relative_abundance))
dim(relabunds)
bubbledata<-cbind(otucount,relabunds[3])
head(bubbledata)
#SHowing between phylums
bubbledata[bubbledata==0]<-NA
#Showing between species
nbubbledata<-bubbledata
ggplot(bubbledata,aes(x=variable,y=Numb_otu,color=Phylum,size=abundance))+
scale_color_manual(values=c(AcidobacteriotaCol,ActinobacteriotaCol,BacteroidotaCol,
CalditrichotaCol,ChloroflexiCol,CrenarchaeotaCol,CyanobacteriaCol,
DadabacteriaCol,DeferrisomatotaCol,DeinococcotaCol,DesulfobacterotaCol,
EntotheonellaeotaCol,GemmatimonadotaCol,
LatescibacterotaCol,MyxococcotaCol,NB1jCol,NitrospinotaCol,NitrospirotaCol,
PlanctomycetotaCol,ProteobacteriaCol,SAR324cladeCol,SpirochaetotaCol,
UnclassifiedCol,VerrucomicrobiotaCol))+labs(x="Species",y="Phylum Richness",size="Relative abundance")+
scale_size(range = c(.9,15))+theme_bw()+geom_jitter(width=0.3,alpha=0.9)+scale_x_discrete(labels=c("Tethya aurantium","Tethia citrina","Tethya meloni"))+
theme(axis.text.x = element_text(face = "italic"),legend.margin = margin(0,0,0,-2))+
guides(color = guide_legend(override.aes = list(size = 5),ncol=2),size=guide_legend(nrow=1) )
